<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT AI Clone + Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #212121;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #383838;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4d4d4d;
        }

        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .message-user {
            background-color: #2f2f2f;
            border-radius: 24px;
            padding: 12px 20px;
        }

        .dot-pulse {
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .dot-pulse:nth-child(1) { animation-delay: -0.32s; }
        .dot-pulse:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .sidebar-collapsed-hide {
            display: none;
        }
        .sidebar-expanded .sidebar-collapsed-hide {
            display: block;
        }
    </style>
</head>
<body class="text-[#ececec] overflow-hidden">

    <div id="app" class="flex h-screen w-full">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar-transition w-[260px] bg-[#171717] flex-shrink-0 flex flex-col z-40 relative h-full overflow-hidden sidebar-expanded">
            <div class="p-3 flex flex-col gap-2">
                <div class="flex items-center justify-between h-10">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-[#2f2f2f] rounded-lg text-gray-400">
                        <i data-lucide="panel-left" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="sidebar-collapsed-hide mt-2 space-y-1">
                    <button onclick="createNewChat()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-[#2f2f2f] transition-all text-sm font-medium text-white group text-left">
                         <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Новый чат</span>
                    </button>
                    <div class="relative px-1">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                        <input type="text" placeholder="Поиск чатов" class="w-full bg-[#212121] border-none rounded-lg py-1.5 pl-9 pr-3 text-sm focus:ring-1 focus:ring-gray-600 outline-none placeholder-gray-500">
                    </div>
                </div>

                <div id="collapsed-icons" class="hidden flex flex-col items-center gap-4 mt-4">
                    <button onclick="createNewChat()" title="Новый чат" class="p-2 hover:bg-[#2f2f2f] rounded-lg text-gray-400">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div class="sidebar-collapsed-hide flex-1 overflow-y-auto px-3 space-y-1 custom-scrollbar">
                <div class="mt-4 mb-2 px-3 text-[11px] font-bold text-gray-500 uppercase tracking-wider">История</div>
                <div id="chat-list"></div>
            </div>

            <div class="mt-auto p-3 border-t border-white/5 bg-[#171717]">
                <button class="flex items-center gap-3 w-full px-2 py-2 hover:bg-[#2f2f2f] rounded-xl transition-colors text-sm justify-center sidebar-expanded:justify-start">
                    <div class="w-8 h-8 rounded-full bg-orange-600 flex-shrink-0 flex items-center justify-center text-[10px] font-bold">JD</div>
                    <span class="sidebar-collapsed-hide font-medium truncate text-left">Профиль</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col relative h-full w-full overflow-hidden bg-[#212121]">
            <header class="p-3 flex items-center justify-between md:justify-start gap-4 z-30">
                <div class="flex items-center gap-2">
                    <button id="mobile-toggle" onclick="toggleSidebar()" class="md:hidden p-2 hover:bg-[#2f2f2f] rounded-xl text-gray-400">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    <div class="relative">
                        <button id="model-select-btn" class="flex items-center gap-2 px-3 py-2 hover:bg-[#2f2f2f] rounded-xl text-lg font-bold transition-all">
                            <span id="current-model-name">Gemini 3 Pro</span>
                            <i data-lucide="chevron-down" class="text-gray-500 w-4 h-4"></i>
                        </button>
                        <div id="model-dropdown" class="hidden absolute top-full left-0 mt-2 w-64 bg-[#2f2f2f] border border-[#383838] rounded-2xl shadow-2xl z-50 p-1.5">
                            <div id="model-options"></div>
                        </div>
                    </div>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto px-4 custom-scrollbar">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center max-w-2xl mx-auto pb-24 text-center">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-8 shadow-xl">
                        <i data-lucide="sparkles" class="text-black w-6 h-6 fill-current"></i>
                    </div>
                    <h1 class="text-[32px] font-bold text-white mb-10 tracking-tight">Чем я могу помочь?</h1>
                </div>

                <div id="chat-messages" class="max-w-3xl mx-auto pt-8 pb-40 w-full hidden"></div>
            </div>

            <!-- INPUT AREA -->
            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-[#212121] via-[#212121] to-transparent pt-12 pb-8 px-4 z-20">
                <div class="max-w-3xl mx-auto relative">
                    
                    <!-- Image Preview Area -->
                    <div id="image-preview-container" class="hidden mb-4 flex gap-2">
                        <div class="relative w-20 h-20 rounded-xl overflow-hidden border border-[#383838]">
                            <img id="image-preview" src="" class="w-full h-full object-cover">
                            <button onclick="clearImage()" class="absolute top-1 right-1 bg-black/50 rounded-full p-1 hover:bg-black">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <div class="relative flex items-end w-full bg-[#2f2f2f] rounded-[26px] border border-[#383838] transition-all focus-within:border-[#4d4d4d] shadow-2xl backdrop-blur-md overflow-hidden">
                        
                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        
                        <button onclick="document.getElementById('file-input').click()" class="p-2 mb-2 ml-3 text-gray-500 hover:text-white transition-colors flex-shrink-0">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>

                        <textarea
                            id="user-input"
                            placeholder="Спросите что-нибудь..."
                            class="w-full max-h-[200px] bg-transparent border-0 focus:ring-0 resize-none py-4 px-2 text-[16px] text-white placeholder-gray-500 outline-none leading-relaxed"
                            rows="1"
                        ></textarea>
                        
                        <button 
                            id="send-btn"
                            onclick="handleSend()"
                            class="mb-2 mr-3 p-2 rounded-full transition-all duration-200 flex-shrink-0 bg-[#1a1a1a] text-[#2f2f2f] cursor-not-allowed"
                            disabled
                        >
                            <i data-lucide="arrow-up" class="w-5 h-5" stroke-width="3"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "https://api.onlysq.ru/ai/v2";
        const AVAILABLE_MODELS = [
            { id: "gemini-3-pro", name: "Gemini 3 Pro", description: "Умная и видит картинки", color: "text-purple-400" },
            { id: "gpt-5.2-chat", name: "ChatGPT 5.2", description: "Мощная универсальная", color: "text-blue-400" },
            { id: "grok-2-vision", name: "Grok 2 Vision", description: "Анализ визуальных данных", color: "text-green-400" }
        ];

        let state = {
            sidebarOpen: true,
            currentModel: "gemini-3-pro",
            chats: [],
            currentChatId: null,
            isLoading: false,
            selectedImageBase64: null // Храним картинку здесь
        };

        function init() {
            const saved = localStorage.getItem('gpt_clone_v3_chats');
            if (saved) {
                try {
                    state.chats = JSON.parse(saved);
                    if (state.chats.length > 0) state.currentChatId = state.chats[0].id;
                    else createNewChat();
                } catch (e) { createNewChat(); }
            } else {
                createNewChat();
            }

            renderSidebar();
            renderModelDropdown();
            renderMessages();
            lucide.createIcons();
            
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', updateSendButtonState);
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            document.getElementById('model-select-btn').addEventListener('click', () => {
                document.getElementById('model-dropdown').classList.toggle('hidden');
            });
        }

        // --- Image Handling ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.selectedImageBase64 = e.target.result;
                document.getElementById('image-preview').src = state.selectedImageBase64;
                document.getElementById('image-preview-container').classList.remove('hidden');
                updateSendButtonState();
                lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            state.selectedImageBase64 = null;
            document.getElementById('file-input').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
            updateSendButtonState();
        }

        function updateSendButtonState() {
            const textarea = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const hasText = textarea.value.trim().length > 0;
            const hasImage = !!state.selectedImageBase64;

            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';

            if ((hasText || hasImage) && !state.isLoading) {
                sendBtn.classList.remove('bg-[#1a1a1a]', 'text-[#2f2f2f]', 'cursor-not-allowed');
                sendBtn.classList.add('bg-white', 'text-black');
                sendBtn.disabled = false;
            } else {
                sendBtn.classList.add('bg-[#1a1a1a]', 'text-[#2f2f2f]', 'cursor-not-allowed');
                sendBtn.classList.remove('bg-white', 'text-black');
                sendBtn.disabled = true;
            }
        }

        async function handleSend() {
            const textarea = document.getElementById('user-input');
            const text = textarea.value.trim();
            const image = state.selectedImageBase64;

            if ((!text && !image) || state.isLoading) return;

            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat) return;

            // Формируем контент сообщения (поддержка текста и картинки)
            let messageContent = [];
            if (text) messageContent.push({ type: "text", text: text });
            if (image) messageContent.push({ type: "image_url", image_url: { url: image } });

            // Если только текст, можно слать строкой, но для Vision API лучше всегда массивом
            // Добавляем в историю (для UI сохраним упрощенно, для API - структуру)
            chat.messages.push({ 
                role: "user", 
                content: messageContent,
                _ui_text: text, // Для рендеринга
                _ui_img: image  // Для рендеринга
            });

            if (chat.title === "Новый чат") chat.title = text ? text.slice(0, 30) : "Изображение";
            
            textarea.value = "";
            clearImage();
            state.isLoading = true;
            renderMessages();

            try {
                // Подготовка сообщений для API (убираем UI-поля)
                const apiMessages = chat.messages.slice(-10).map(m => ({
                    role: m.role,
                    content: m.content
                }));

                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer openai" },
                    body: JSON.stringify({
                        model: state.currentModel,
                        request: { messages: apiMessages }
                    })
                });

                const data = await response.json();
                const reply = data?.choices?.[0]?.message?.content || "Ошибка получения ответа.";
                chat.messages.push({ role: "assistant", content: reply });
            } catch (err) {
                chat.messages.push({ role: "assistant", content: `Ошибка: ${err.message}` });
            } finally {
                state.isLoading = false;
                saveAndRender();
            }
        }

        // --- Sidebar & Chat Logic ---
        function toggleSidebar() {
            state.sidebarOpen = !state.sidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const collapsedIcons = document.getElementById('collapsed-icons');
            sidebar.style.width = state.sidebarOpen ? '260px' : '68px';
            state.sidebarOpen ? sidebar.classList.add('sidebar-expanded') : sidebar.classList.remove('sidebar-expanded');
            state.sidebarOpen ? collapsedIcons.classList.add('hidden') : collapsedIcons.classList.remove('hidden');
        }

        function createNewChat() {
            const id = Date.now().toString();
            state.chats = [{ id, title: "Новый чат", messages: [], timestamp: Date.now() }, ...state.chats];
            state.currentChatId = id;
            saveAndRender();
        }

        function selectChat(id) {
            state.currentChatId = id;
            renderSidebar();
            renderMessages();
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) {
                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                if (!state.currentChatId) createNewChat();
            }
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('gpt_clone_v3_chats', JSON.stringify(state.chats));
            renderSidebar();
            renderMessages();
        }

        // --- Rendering ---
        function renderSidebar() {
            const list = document.getElementById('chat-list');
            list.innerHTML = state.chats.map(chat => `
                <div onclick="selectChat('${chat.id}')" class="group flex items-center gap-3 px-3 py-2 rounded-lg text-[13px] cursor-pointer transition-all relative ${state.currentChatId === chat.id ? 'bg-[#2f2f2f] text-white' : 'hover:bg-[#2f2f2f] text-gray-400 hover:text-gray-200'}">
                    <i data-lucide="message-square" class="w-3.5 h-3.5 flex-shrink-0"></i>
                    <span class="truncate flex-1 pr-6">${chat.title}</span>
                    <button onclick="deleteChat(event, '${chat.id}')" class="absolute right-2 p-1 rounded-md hover:text-white text-gray-500 opacity-0 group-hover:opacity-100">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderModelDropdown() {
            const container = document.getElementById('model-options');
            container.innerHTML = AVAILABLE_MODELS.map(m => `
                <button onclick="selectModel('${m.id}')" class="w-full text-left p-3 hover:bg-[#383838] rounded-xl flex items-center justify-between group">
                    <div>
                        <div class="text-sm font-bold ${m.color}">${m.name}</div>
                        <div class="text-[11px] text-gray-400">${m.description}</div>
                    </div>
                </button>
            `).join('');
        }

        function selectModel(id) {
            state.currentModel = id;
            document.getElementById('current-model-name').innerText = AVAILABLE_MODELS.find(m => m.id === id).name;
            document.getElementById('model-dropdown').classList.add('hidden');
        }

        function renderMessages() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const welcome = document.getElementById('welcome-screen');
            const chatMessages = document.getElementById('chat-messages');
            const container = document.getElementById('messages-container');

            if (!chat || chat.messages.length === 0) {
                welcome.classList.remove('hidden');
                chatMessages.classList.add('hidden');
            } else {
                welcome.classList.add('hidden');
                chatMessages.classList.remove('hidden');
                
                chatMessages.innerHTML = chat.messages.map(msg => {
                    let contentHtml = "";
                    
                    if (msg.role === 'user') {
                        // Если это наше расширенное сообщение
                        if (msg._ui_img) contentHtml += `<img src="${msg._ui_img}" class="max-w-xs rounded-xl mb-2 border border-[#383838]">`;
                        if (msg._ui_text) contentHtml += `<div>${escapeHtml(msg._ui_text)}</div>`;
                        // Фолбек для старых сообщений или если структура иная
                        if (!msg._ui_img && !msg._ui_text) contentHtml = formatContent(msg.content);
                    } else {
                        contentHtml = formatContent(msg.content);
                    }

                    return `
                        <div class="flex gap-5 mb-8 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                            ${msg.role === 'assistant' ? `
                                <div class="w-8 h-8 rounded-full bg-[#19c37d] flex items-center justify-center flex-shrink-0 mt-1">
                                    <i data-lucide="sparkles" class="text-white w-4 h-4 fill-current"></i>
                                </div>
                            ` : ''}
                            <div class="max-w-[85%] ${msg.role === 'user' ? 'message-user' : 'pt-1'}">
                                <div class="text-[16px] leading-[1.6] text-[#ececec] font-normal break-words">
                                    ${contentHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                if (state.isLoading) {
                    chatMessages.innerHTML += `
                        <div class="flex gap-5 mb-8">
                            <div class="w-8 h-8 rounded-full bg-[#19c37d] flex items-center justify-center animate-pulse">
                                <i data-lucide="sparkles" class="text-white w-4 h-4 fill-current"></i>
                            </div>
                            <div class="flex items-center gap-1.5 mt-4">
                                <div class="w-1.5 h-1.5 bg-gray-500 rounded-full dot-pulse"></div>
                                <div class="w-1.5 h-1.5 bg-gray-500 rounded-full dot-pulse"></div>
                                <div class="w-1.5 h-1.5 bg-gray-500 rounded-full dot-pulse"></div>
                            </div>
                        </div>
                    `;
                }
            }
            lucide.createIcons();
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        function formatContent(content) {
            if (typeof content !== 'string') return ""; // Обработка массивов объектов
            const parts = content.split(/(```[\s\S]*?```)/g);
            return parts.map(part => {
                if (part.startsWith('```')) {
                    const lang = part.match(/^```(\w*)/)?.[1] || 'txt';
                    const code = part.replace(/^```\w*\n?/, '').replace(/```$/, '').trim();
                    return `<div class="my-4 rounded-xl overflow-hidden border border-[#383838] bg-black">
                        <div class="px-4 py-1 text-xs text-gray-400 bg-[#1e1e1e] border-b border-[#383838] uppercase font-mono">${lang}</div>
                        <pre class="p-4 overflow-x-auto font-mono text-sm"><code>${escapeHtml(code)}</code></pre>
                    </div>`;
                }
                return `<span>${escapeHtml(part)}</span>`;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.onload = init;
    </script>
</body>
</html>